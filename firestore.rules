rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Checks if the user is the specified admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@magician.com';
    }

    // Helper: Checks if the logged-in user matches the userId in the path
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // --- User Profiles and Private Data ---
    match /users/{userId} {
      // Magician can manage their own profile and see all users if admin
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isOwner(userId);

      // Private Magician Tools: Only the owner has access
      match /shows/{doc=**} { allow read, write: if isOwner(userId); }
      match /ideas/{doc=**} { allow read, write: if isOwner(userId); }
      match /clients/{doc=**} { allow read, write: if isOwner(userId); }
      match /performances/{doc=**} { allow read, write: if isOwner(userId); }
      match /settings/{doc=**} { allow read, write: if isOwner(userId); }

      // Audience Input: Magician can read/manage, Audience can only submit (create)
      match /feedback/{docId} {
        allow read, delete, update: if isOwner(userId);
        allow create: if true; 
      }
      match /questions/{docId} {
        allow read, delete, update: if isOwner(userId);
        allow create: if true;
      }
    }

    // --- App Suggestions ---
    match /app_suggestions/{suggestionId} {
      allow create: if true; // Anyone can submit feedback about the app
      allow read, write: if isAdmin(); // Only admins can see and triage suggestions
    }
  }
}